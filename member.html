<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <title>Member - FOKSI Absensi</title>
    <link rel="stylesheet" href="assets/css/style.css">
</head>
<body>
    <div class="dashboard-container">
        <div class="card">
            <h2>Halo, <span id="userName">Member</span>!</h2>
            <p id="userRegion">Regional ...</p>
            
            <div id="absenBox">
                <h3>Form Absensi</h3>
                <p>Silakan pilih status kehadiran Anda untuk kegiatan hari ini.</p>
                
                <select id="statusKehadiran">
                    <option value="H">Hadir (H)</option>
                    <option value="I">Izin (I)</option>
                    <option value="S">Sakit (S)</option>
                </select>
                
                <button id="btnKirimAbsen">Kirim Absensi</button>
            </div>

            <button onclick="logout()" class="secondary">Logout</button>
        </div>
    </div>

    <script type="module">
        import { auth, db } from './assets/js/firebase-config.js';
        import { signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { doc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        let currentUserData = {};

        // Cek Login & Ambil Data Profil
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                const docRef = doc(db, "users", user.uid);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    currentUserData = docSnap.data();
                    currentUserData.uid = user.uid; // Simpan UID
                    
                    document.getElementById('userName').innerText = currentUserData.nama;
                    document.getElementById('userRegion').innerText = "Regional " + currentUserData.regional + " | " + currentUserData.sma;
                }
            } else {
                window.location.href = "index.html";
            }
        });

        // Fungsi Kirim Absen
        document.getElementById('btnKirimAbsen').addEventListener('click', async () => {
            const status = document.getElementById('statusKehadiran').value;

            try {
                // Simpan ke collection 'absensi'
                await addDoc(collection(db, "absensi"), {
                    uid: currentUserData.uid,
                    nama: currentUserData.nama,
                    regional: currentUserData.regional,
                    sma: currentUserData.sma,
                    keterangan: status,
                    tanggal: new Date().toISOString().split('T')[0], // YYYY-MM-DD
                    timestamp: new Date()
                });
                
                alert("Absensi Berhasil!");
                document.getElementById('absenBox').innerHTML = "<p style='color:green; font-weight:bold;'>Anda sudah melakukan absensi hari ini.</p>";
                
            } catch (e) {
                alert("Gagal absen: " + e.message);
            }
        });

        window.logout = () => {
            signOut(auth).then(() => window.location.href = "index.html");
        }
    </script>
</body>
</html>